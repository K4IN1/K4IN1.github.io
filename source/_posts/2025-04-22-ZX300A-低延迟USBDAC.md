---
title: 适用于WalkmanZX300A的低延迟USBDAC
date: 2025-04-22 00:57:00
tags:
- Walkman
- USBDAC
categories:
- 教程
---
# 修改固件解决WalkmanUSBDAC延迟问题

## 背景  

索尼Walkman的USBDAC功能具有巨大延迟，对于简易的桌面HIFI来说极为不友好。观影倒是无所谓，但是游戏语音则会造成巨大的影响。  
之前无意中在GitHub上搜索了Sony关键字，找到了这个[项目](https://github.com/zhangboyang/llusbdac)。他可以修改Walkman的固件，实现低延迟的PCM输出，与此同时还不会影响播放器的正常输出，于是尝试魔改我的ZX300A  
<!-- more -->
### 注意

关于固件：*Walkman的声音和固件版本有很大关系，这里建议多下几个**不同版本**的固件多试一试，选自己喜欢的固件去魔改*

## 操作

这里选择ZX300A公认的最好固件V1.10，虽然没有了2.x版本的蓝牙输出功能，但是声音是真的好不少，下载地址请自行寻找  
这里是使用了发行版Linux，Ubuntu22.04进行编译，最终修改完的固件依然要是用官方的windows更新文件进行安装，***确保自己拥有对应的两个环境再进行操作***

### 安装需要使用的软件包

``` bash
sudo apt install -y git make wget
```

### 克隆代码

``` bash
git clone https://github.com/zhangboyang/llusbdac.git
```

### 准备工具

``` bash
cd llusbdac/
./get_toolchain.sh
```

当出现以下内容时，就可以配置环境变量了  

```text
=== TO ADD COMPILER TO YOUR $PATH, PLEASE RUN ===
```

### 配置环境变量

``` bash
. setpath
arm-linux-gnueabinf-gcc --version
```

如果出现`gcc version x.x.x`就认为配置正确

## 准备Walkman源码

### 下载

进入Sony的Linux Kernel源代码[下载界面](https://oss.sony.net/Products/Linux/Audio/category01.html#ca3)  
找到自己的型号，点进去下载对应的linux-kernel-3.xx.xx.tar.gz  
在Linux系统下下载，可以直接用浏览器也可以用wget  

``` bash
wget <下载链接>
```

### 解压

记得把下面的文件名改成你自己的  

``` bash
mkdir kernel
tar -xzf linux-kernel-3.10.26.tar.gz -C kernel
cd kernel
cat HowToBuild.txt
```

### 获取配置文件

复制输出的那一段`Kernel Configuration Infomation`  
注意其中的那一段路径`arch/arm/xxxxxx`  
每个人的不一定是一样的，然后复制对应的配置文件

``` bash
cp arch/arm/configs/xxxxxxx .config
```

然后就可以开始编译了

### 编译配置文件

``` bash
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- olddefconfig
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- prepare
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- scripts
```

等待编译完成即可，如果有Warning不用在意，Error则要自己想办法解决，每个人都不一样  
一般是环境问题，缺什么装什么，充分利用搜索引擎

### 编译LLUSBDAC

回到llusbdac目录，开始编译

``` bash
cd ../llusbdac/
make
```

最后有`sha256sum llusbdac.ko > llusbdac.sha256`即可
把编译出来的llusbdac都保存好，复制到Windows备用

## 准备索尼更新软件

### 下载更新器

1. 前往[索尼亚洲官网](https://www.sony-asia.com/electronics/support/digital-music-players-nw-nwz-a-series)，寻找自己的型号和对应的Software。  

2. 我这边也提供一个ZX300/A的1.10[固件](https://pan.baidu.com/s/1HWUimoB73ZijuToXG_xxJA)（提取码：pfzc）。
3. 运行更新软件，然后到更新器界面，先不要点击“我同意”和“下一步”。
4. 打开Windows的任务管理器，右键打开`Software Update Tool`的**文件所在的位置**。
5. 进入`Data/Device`目录，找到`NW_WM_FW.UPG`固件更新包并复制出来。

### 解包固件

1. 下载[UPG工具](https://www.rockbox.org/wiki/SonyNWUPGTool)
2. 把这个工具和刚复制出来的固件放在同一个文件夹
3. 打开Powershell或cmd，进入该目录，执行以下命令然后用Powershell或者cmd到这个目录下面
4. 还是在UPG工具的网站，找到自己Series对应的codename,记住自己的codename，例如我的ZX300A对应 `nw-zx300`  
5. shell输入

    ``` Powershell
    .\upgtool-v3.exe -d -e -o UNPACK -m nw-zx300 NW_WM_FW.UPG
    ```

6. 在目录下找到解包后的UNPACKx.bin文件，用文本编辑器打开UNPACK0.bin。
7. 全选，看右下角的文件字符数，应该是8192个  
直接拉到最后一行，找到`log "UPDATED!"`在他的上面添加LLUSBDAC相关的内容

    ``` bash
    sleep 3
    mount -o remount,rw /contents
    (cd /contents && busybox sha256sum -c LLUSBDAC.SUM && busybox sh LLUSBDAC.DAT && rm -f LLUSBDAC.SUM LLUSBDAC.DAT)
    mount -o remount,ro /contents
    sync
    sync
    sleep 3
    ```

    把最后的`0x00`删除对应的数量，一直到右下角为8192个字符  
8. 然后重新打包UPG  

    ``` powershell
    .\upgtool-v3.exe -d -c -m nw-zx300 MYFW.UPG UNPACK0.bin UNPACK1.bin UNPACK2.bin UNPACK3.bin UNPACK4.bin UNPACK5.bin UNPACK6.bin UNPACK7.bin UNPACK8.bin
    ```

    随后就打包出来了对应的`MYFW.UPG`  
    插上你的Walkman，打开大容量储存设备功能

### 替换原版固件

1. 使用Pip安装`wmi`

    ``` shell
    pip install -i https://opentuna.cn/pypi/web/simple wmi
    ```

2. 执行安装脚本

    ```shell
    python .\llusbdac_installer.py
    ```

3. 勾选1、2项目即可,然后还是不要点击我同意和下一步
4. 进入Walkman的目录，能找到`LLUSBDAC.DAT`和`LLUSBDAC.SUM`，这样就说明我们的内容上传成功了，直接关掉升级器
5. 打开官方的升级软件，找到升级器的解压目录  
6. 这个时候复制我们之前打包好的`MYFW.UPG`替换掉官方的那个`NW_WM_FW.UPG`然后重新命名`NW_WM_FW.UPG`  
7. 按照提示完成安装就好，重启完了在USBDAC界面连按三下歌曲控制按键就可以了，重启播放器就可以关闭这个功能。
